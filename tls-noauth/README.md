# (K8s Internal) TLS and No Auth

This exercise has a similar result to [notls-noauth](../notls-noauth/), but we will be encrypting comminication using TLS, and leveraging CFK to auto generate the required certificates of each service.

For each Resource in the deploying manifest [`cp-platform.yaml`](cp-platform.yaml), not the TLS entries

```yaml
tls:
  autoGeneratedCerts: true
```

For CFK to auto generate the Certificates a TLS Secret named `ca-pair-sslcerts` must be created with the signing CA (Certificate Authority) Certificate and its Key.

```bash
mkdir generated

openssl genrsa -out generated/InternalCAkey.pem 2048

openssl req -x509 -new -nodes \
  -key generated/InternalCAkey.pem \
  -days 365 \
  -out generated/InternalCAcert.pem \
  -subj "/C=ES/ST=VLC/L=VLC/O=Demo/OU=GCP/CN=InternalCA"

kubectl create secret tls ca-pair-sslcerts \
--cert=generated/InternalCAcert.pem \
--key=generated/InternalCAkey.pem \
--namespace confluent
```

To deploy the platform run:

```bash
kubectl apply -f cp-platform.yaml
```

For each service you can perform the following tests...

## Test Kafka Produce and Consume

Descriptor file `test-kafka-app.yaml` creates a topic named `app-topic`, a secret named `kafka-client-tls-properties` with property file to connect internally (to K8s) to kafka (see [internal-client.properties](internal-client.properties)), and two pods one that will produce 10.000 records in 1 second interval and another pod that will consume from the same topic.

```bash
kubectl apply -f test-kafka-app.yaml
```

You can follow the logs of each pod once running to see the producer and consumer apps in action

```bash
kubectl logs -f producer-app

kubectl logs -f consumer-app
```

To tear down the app run the code below, but you can leave it running until you test Confluent Control Center (C3) below

```bash
kubectl delete -f test-kafka-app.yaml
```

## Test SR (Schema Registry)

This is a simple check to confirm the REST endpoint works

```bash
## CHECK GENERATED CERTIFICATE
kubectl exec -it kafka-0 -- \
  openssl s_client -connect schemaregistry.confluent.svc.cluster.local:8081 </dev/null 2>/dev/null | \
  openssl x509 -noout -text | \
  grep -E '(Issuer: | DNS:)'

## CHECK THE SERVICE
kubectl exec -it kafka-0 -- curl -k https://schemaregistry.confluent.svc.cluster.local:8081/schemas/types
```

## Test Connect

This is a simple check to confirm the REST endpoint works

```bash
## CHECK GENERATED CERTIFICATE
kubectl exec -it kafka-0 -- \
  openssl s_client -connect connect.confluent.svc.cluster.local:8083 </dev/null 2>/dev/null | \
  openssl x509 -noout -text | \
  grep -E '(Issuer: | DNS:)'

## CHECK THE SERVICE
kubectl exec -it kafka-0 -- curl -k https://connect.confluent.svc.cluster.local:8083/
```

## Test ksqlDB

This is a simple check to confirm the REST endpoint works

```bash
## CHECK GENERATED CERTIFICATE
kubectl exec -it kafka-0 -- \
  openssl s_client -connect ksqldb.confluent.svc.cluster.local:8088 </dev/null 2>/dev/null | \
  openssl x509 -noout -text | \
  grep -E '(Issuer: | DNS:)'

## CHECK THE SERVICE
kubectl exec -it kafka-0 -- curl -k https://ksqldb.confluent.svc.cluster.local:8088/info
```

## Test Confluent Control Center (C3)

You need to port-forward port 9021 from C3 pod. Either using the [confluent kubectl plugin](https://docs.confluent.io/operator/current/co-deploy-cfk.html#install-confluent-plugin).

```bash
## This will also open your browser automatically
kubectl confluent dashboard controlcenter
```

Or with kubectl port-foward

```bash
kubectl port-forward controlcenter-0 9021:9021 -n confluent

## Open your browser and navigate to https://localhost:9021
```

**NOTE:** *When using a self-signed certificates, your browser will display a `NET::ERR_CERT_AUTHORITY_INVALID` error message, dependening on the browser there are mechanisms to override and accept the risk of insecure browsing and proceed to C3 page, optionally, you can import the CA cert in your SO/browser certificate trust chain, and restart the browser.

If you have not tear down the producer application, you should see the topic and its content.

### Test C3/SR/ksqlDB

Use the following queries to test Schema Registry and ksqldb from within C3

```sql
CREATE STREAM users  (id INTEGER KEY, gender STRING, name STRING, age INTEGER) WITH (kafka_topic='users', partitions=1, value_format='AVRO');
```

```sql
INSERT INTO users (id, gender, name, age) VALUES (0, 'female', 'sarah', 42);
INSERT INTO users (id, gender, name, age) VALUES (1, 'male', 'john', 28);
INSERT INTO users (id, gender, name, age) VALUES (42, 'female', 'jessica', 70);
```

**NOTE:** Push Queries will seem "hanged" and will not work since push queries need to open a web socket connection from ksqldb from your browser, and ksqldb is not reachable from the outside in this exercise, the query remains just for completness.

But you can still check the `users` topic content and it's assigned schema in the `Topics` sections on the left side of C3 UI.

```sql
-- Make sure to set auto.offset.reset=earliest
SELECT id, gender, name, age FROM users WHERE age<65 EMIT CHANGES;
-- You should get 2 records
```

## Tear down the platform

```bash
kubectl delete -f cp-platform.yaml
```
