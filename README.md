# CFK-SANDBOX
Confluent for Kubernetes deployment with TLS user-provided certificates, RBAC backed by LDAP and with different auth configurations, LDAP, SASL-PLAIN and mTLS.
Kafka Listeners:
* INTERNAL/REPLICATION -> mTLS
* EXTERNAL -> LDAP
* ADHOC (Custom) -> SASL/PLAIN

## Requirements
K8s cluster accessible via kubectl is required.
Helm needed to install CFK

### Prepare Certificates
See tlscerts/README.md

### Deploy CFK via HELM

#### Create namespace
```bash
$ kubectl create namespace confluent
$ kubectl config set-context --current --namespace confluent
```
#### (Optional) Using auto-generated Internal Certificates
See [Deploy customized CFK](https://docs.confluent.io/operator/current/co-deploy-cfk.html#deploy-customized-co) documentation to create a copy of the `values.yaml` helm file... and then follow Steps for [Configure auto-generated certificates](https://docs.confluent.io/operator/current/co-network-encryption.html#configure-auto-generated-certificates) in the documentation

```
helm upgrade --install confluent-operator \
  confluentinc/confluent-for-kubernetes \
  --set managedCerts.enabled=true \
  --set managedCerts.caCertificate.secretRef=internal-ca \
  --namespace confluent

### CUSTOM CRD's SHOULD USE THIS
# spec:
#   tls:
#     autoGeneratedCerts: true
```

### USERS FOR KAFKA
Create a file with a similar json content (assume `kafka-plain-users.json`)

```
{
"client1": "client1-secret",
"app1": "app1-secret",
"admin": "admin-secret"
}
```

Create a secret for the file
```bash
kubectl create secret generic kafka-users --from-file=plain-users.json=kafka-plain-users.json 
```


#### TIPS TO ENCODE THE SECRETS IN A FILE...

##### Create file from scratch
```bash
kubectl create secret generic kafka-users --from-file=plain-users.json=kafka-plain-users.json --dry-run=client --output=yaml > secret.yaml
```

##### REPLACE VALUE

Given a base `secrets.yaml.tmpl` file

```
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: kafka-users
  namespace: confluent
data:
  plain-users.json: PLAIN_USERS_JSON
```

```bash
sed "s/PLAIN_USERS_JSON/`cat kafka-plain-users.json|base64 -w0`/g" secrets.yml.tmpl | \
sed <chain the next replacement> | \
 > secrets.yaml
```


kubectl get secret kafka-users -o jsonpath={.data}



kafka-topics --bootstrap-server kafka.confluent.svc.cluster.local:9092 --command-config client.properties --list